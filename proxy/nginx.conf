daemon off;

worker_processes auto;

events {
  worker_connections 1024;
}

http {
  log_format upstream_logging '$remote_addr - $remote_user [$time_local] $server_name '
    '"$request_method $scheme://$host$request_uri $server_protocol" $status $upstrean_response_time ';
  access_log logs/access.log upstream_logging;

  map "" $my_backend_server {
    default 10.10.10.21;
  }

  upstream ganache {
    server $my_backend_server:11001;
  }
  
  upstream did-verifier {
    server $my_backend_server:11003;
  }
  
  upstream did-issuer {
    server $my_backend_server:11004;
  }
  
  upstream authentication {
    server $my_backend_server:11005;
  }
  
  upstream rabbitmq {
    server $my_backend_server:11006;
  }
  
  upstream fn-discovery {
    server $my_backend_server:11008;
  }

  upstream fn-transaction {
    server $my_backend_server:11009;
  }

  upstream payment {
    server $my_backend_server:11010;
  }

  server {
    listen  11000 ;
    listen  [::]:11000;
    server_name  meca;

    #access_log  /var/log/nginx/host.access.log  main;

    location / {
      root  /usr/share/nginx/html;
      index index.html index.htm;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    error_page  500 502 503 504 /50x.html;
    location = /50x.html {
      root  /usr/share/nginx/html;
    }

    location /ganache/ {
      proxy_pass http://ganache/;
    }

    location /did-verifier/ {
      proxy_pass http://did-verifier/;
    }

    location /did-issuer/ {
      proxy_pass http://did-issuer/;
    }

    location /authentication/ {
      proxy_pass http://authentication/;
    }

    location /rabbitmq/ {
      proxy_pass http://rabbitmq/;
    }

    location /fn-discovery/ {
      proxy_pass http://fn-discovery/;
    }

    location /fn-transaction/ {
      proxy_pass http://fn-transaction/;
    }

    location /payment/ {
      proxy_pass http://payment/;
    }
  }
}

# stream {
#   # upstream rabbitmq {
#   #   server localhost:5672;
#   # }

#   server {
#     listen 11000;
#     proxy_pass localhost:15672;
#   }
# }
