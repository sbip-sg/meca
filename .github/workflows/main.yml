name: Deploy to SBIP Server

on:
  push:
    branches:
      - cd

jobs:
  push:
    runs-on: ubuntu-latest

    steps:
      # - name: Checkout repository
      #   uses: actions/checkout@v2

      # - name: Login to DockerHub Registry
      #   run: echo ${{ secrets.DOCKERHUB_TOKEN }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin

      # - name: Build and Push Docker Images
      #   env: 
      #     KEY1: ${{ secrets.COMPOSEKEY1 }}
      #     KEY2: ${{ secrets.COMPOSEKEY2 }}
      #     KEY3: ${{ secrets.COMPOSEKEY3 }}
      #     KEY4: ${{ secrets.COMPOSEKEY4 }}
      #     KEY5: ${{ secrets.COMPOSEKEY5 }}
      #     KEY6: ${{ secrets.COMPOSEKEY6 }}
      #     KEY7: ${{ secrets.COMPOSEKEY7 }}
      #     KEY8: ${{ secrets.COMPOSEKEY8 }}
      #   run: |
      #     mkdir keys
      #     echo "$KEY1" >> keys/access_token_key.txt
      #     echo "$KEY2" >> keys/refresh_token_key.txt
      #     echo "$KEY3" >> keys/0x52c328ef8b382b1d71cc262b868d803a137ab8d8
      #     echo "$KEY4" >> keys/wallet_address.txt
      #     echo "$KEY5" >> keys/wallet_private_key.txt
      #     echo "$KEY6" >> keys/server_host_name.txt
      #     echo "$KEY7" >> keys/server_host_did.txt
      #     echo "$KEY8" >> keys/server_host_po_did.txt

      #     docker-compose -f docker-compose-sbip.yaml build
      #     docker-compose -f docker-compose-sbip.yaml push

      - name: VPN into SoC network
        run: |
          sudo apt update && sudo apt install -y openconnect
          echo "${{ secrets.SOC_VPN_PASSWORD }}" | sudo openconnect --protocol=fortinet staffvpn.comp.nus.edu.sg -u ${{ secrets.SOC_VPN_USERNAME }} --passwd-on-stdin --background

      - name: SSH into SBIP Server and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            ssh worker-111 "cd mec_anywhere && docker compose -f docker-compose-sbip.yaml pull && docker compose -f docker-compose-sbip.yaml up -d"
